pipeline {
    agent any

    environment {
        JMETER_VERSION = "5.6.3"
        JMETER_HOME = "/opt/jmeter/apache-jmeter-${JMETER_VERSION}"
        JTL_REPORT_FILE = 'results/results.jtl' // 성능 플러그인이 분석할 결과 파일 경로
        PERFORMANCE_REPORT_DIR = 'performance-report' // 성능 보고서가 생성될 디렉토리
        HTML_REPORT_DIR = 'report_output' // JMeter HTML 보고서 디렉토리
    }

    stages {
        stage('Run Tests') {
            steps {
                script{
                    sh 'rm -f results.jtl'
                    sh 'rm -rf report_output' // reports -> report_output으로 수정 (로그 참조)
                    sh 'mkdir -p results'      // 결과 파일 저장 디렉토리 생성
                    sh 'mkdir -p report_output' // 보고서 출력 디렉토리 생성

                    sh """
                        echo "시작"
                        ${env.JMETER_HOME}/bin/jmeter -n \\
                            -t -n -t MyTestPlan.jmx \\
                            -l .\results\results.jtl \\
                            -e -o .\results\report_output
                    """
                }
            }
        }

        stage('Publish Performance Report') {
            steps {
                perfReport parsers: [[type: 'JMeter']], // JMeter 결과 파일임을 명시
                           sourceDataFiles: "${JTL_REPORT_FILE}", // 분석할 결과 파일 경로
                           errorFailedThreshold: 1.0,
                           errorUnstableThreshold: 0.5,
                           errorResponseTimeFailedThreshold: 1000, // 평균 응답 시간 실패 임계값
                           errorResponseTimeUnstableThreshold: 800, // 평균 응답 시간 불안정 임계값
                           errorMedianResponseTimeFailedThreshold: 900, // 중앙값 응답 시간 실패 임계값
                           errorMedianResponseTimeUnstableThreshold: 700, // 중앙값 응답 시간 불안정 임계값
                           errorPercentile90ResponseTimeFailedThreshold: 1500, // 90번째 백분위수 응답 시간 실패 임계값
                           errorPercentile90ResponseTimeUnstableThreshold: 1200, // 90번째 백분위수 응답 시간 불안정 임계값
                           baselineBuild: true // 임계값 초과 시 빌드 실패 여부
                }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML(
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: false,
                    reportDir: "${HTML_REPORT_DIR}",
                    reportFiles: 'index.html',
                    reportName: 'JMeter Performance Report'
                )
            }
        }
    }

    post {
        always {
            echo 'Build finished.'
            archiveArtifacts artifacts: "${HTML_REPORT_DIR}/**/*", allowEmptyArchive: true
        }
    }
}
